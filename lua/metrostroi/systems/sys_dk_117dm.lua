--------------------------------------------------------------------------------
-- Тяговый электродвигатель постоянного тока (ДК-117ДМ)
--------------------------------------------------------------------------------
Metrostroi.DefineSystem("DK_117DM")

function TRAIN_SYSTEM:Initialize()
	self.Name = "DK_117DM"
	
	-- Winding resistance
	self.Rw = 0.180 -- Ohms
	
	-- Voltage generated by engine
	self.E13 = 0.0 -- Volts
	self.E24 = 0.0 -- Volts
	
	-- Rotation rate
	self.RotationRate = 0.0
	
	-- Magnetic flux in the engine
	self.MagneticFlux13 = 0.0
	self.MagneticFlux24 = 0.0
	
	-- Moment generated by the engine
	self.Moment13 = 0.0
	self.Moment24 = 0.0
end

function TRAIN_SYSTEM:Inputs()
	return { }
end

function TRAIN_SYSTEM:Outputs()
	return { "MagneticFlux13", "MagneticFlux24", "RotationRate", 
			"E13", "E24", "Moment13", "Moment24",
			"Istator13", "Ishunt13", "Istator24", "Ishunt24" }
end

function TRAIN_SYSTEM:Think(dT)
	local Train = self.Train
	local minimumFlux = 0.7 -- Подмагничивание при низких токах
	
	-- Calculate voltage on the stator coils and shunt
	local U13 = Train.Electric.I13 * Train.Electric.Rs13
	local U24 = Train.Electric.I24 * Train.Electric.Rs24
	
	-- Calculate current through stator
	--self.Istator13 = Train.Electric.I13
	--self.Istator24 = Train.Electric.I24
	self.Ishunt13  = U13 / (Train.Electric.Shunt1Resistance)
	self.Istator13 = U13 / (self.Rw/2)
	self.Ishunt24  = U24 / (Train.Electric.Shunt2Resistance)
	self.Istator24 = U24 / (self.Rw/2)
	if Train.Tb.Value == 1.0 then
		local I1,I2 = self.Istator13,self.Istator24
		self.Istator13 = -I2
		self.Istator24 = -I1
	end

	-- Calculate magnetic flux in the engine
	currentMagneticFlux13 = (1.0/100.0) * 300.0*(1-math.exp(-3.0*self.Istator13/300))
	currentMagneticFlux24 = (1.0/100.0) * 300.0*(1-math.exp(-3.0*self.Istator24/300))
	currentMagneticFlux13 = math.min(2.2,math.max(minimumFlux,currentMagneticFlux13))
	currentMagneticFlux24 = math.min(2.2,math.max(minimumFlux,currentMagneticFlux24))
	
	self.MagneticFlux13 = self.MagneticFlux13 + 1.0 * (currentMagneticFlux13 - self.MagneticFlux13) * dT
	self.MagneticFlux24 = self.MagneticFlux24 + 1.0 * (currentMagneticFlux24 - self.MagneticFlux24) * dT

	-- Get rate of engine rotation
	local currentRotationRate = 2200 * ((Train.FrontBogey.Speed + Train.RearBogey.Speed)/90) / 2
	self.RotationRate = self.RotationRate + 5.0 * (currentRotationRate - self.RotationRate) * dT
	
	-- Calculate voltage generated by engines from magnetic flux
	self.E13 = 0.200 * self.RotationRate * self.MagneticFlux13
	self.E24 = 0.200 * self.RotationRate * self.MagneticFlux24
	
	self.E13 = math.max(-2000,math.min(2000,self.E13))
	self.E24 = math.max(-2000,math.min(2000,self.E24))
	
	--print(self.E13 / Train.Electric.I13)
	
	-- Calculate engine force (moment)
	self.Moment13 = (1.0/1000.0) * Train.Electric.I13 * self.MagneticFlux13
	self.Moment24 = (1.0/1000.0) * Train.Electric.I24 * self.MagneticFlux24
	--if Train.Electric.I13 < 0.0 then self.Moment13 = - self.Moment13 end
	--if Train.Electric.I24 < 0.0 then self.Moment24 = - self.Moment24 end
	
	-- Reverser switch
	local reverse = (Train.RR.Value > 0.5)
	
	-- Apply moment
	Train.FrontBogey.MotorForce = 40000
	Train.FrontBogey.Reversed = (Train.RR.Value > 0.5)
	Train.RearBogey.MotorForce  = 40000
	Train.RearBogey.Reversed = (Train.RR.Value < 0.5)
	
	if (math.abs(Train.Electric.I13) > 1.0) or (math.abs(Train.Electric.I24) > 1.0) then
		Train.RearBogey.MotorPower  = (self.Moment13 + self.Moment24) / 2
		Train.FrontBogey.MotorPower = (self.Moment13 + self.Moment24) / 2
	else
		Train.RearBogey.MotorPower  = 0.0
		Train.FrontBogey.MotorPower = 0.0
	end
	
	-- Output things
	self:TriggerOutput("MagneticFlux13",self.MagneticFlux13)
	self:TriggerOutput("MagneticFlux24",self.MagneticFlux24)
	self:TriggerOutput("RotationRate",self.RotationRate)
	self:TriggerOutput("E13",self.E13)
	self:TriggerOutput("E24",self.E24)
	self:TriggerOutput("Moment13",self.Moment13)
	self:TriggerOutput("Moment24",self.Moment24)
	self:TriggerOutput("Istator13",self.Istator13)
	self:TriggerOutput("Istator24",self.Istator24)
	self:TriggerOutput("Ishunt13",self.Ishunt13)
	self:TriggerOutput("Ishunt24",self.Ishunt24)
end
